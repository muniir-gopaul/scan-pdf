import{u as U,Q as k,a as q}from"./use-quasar-CgGvTes6.js";import{c as F,r as m,N as L,O as N,o as R,g as $,h as A,b as T,P as j,R as E,e as K,S as M,p as G,T as H,U as W,B as O,C as h,D as b,H as f,V as w,I as P,W as X,X as Y,Y as Z,K as z,Z as D,_ as J,L as ee,$ as te,a0 as ae}from"./index-B-FUFzE6.js";import{api as Q}from"./axios-B2fH7xVF.js";const oe=F({name:"QForm",props:{autofocus:Boolean,noErrorFocus:Boolean,noResetFocus:Boolean,greedy:Boolean,onSubmit:Function},emits:["reset","validationSuccess","validationError"],setup(i,{slots:v,emit:c}){const p=$(),n=m(null);let r=0;const s=[];function g(e){const u=typeof e=="boolean"?e:i.noErrorFocus!==!0,C=++r,_=(o,l)=>{c(`validation${o===!0?"Success":"Error"}`,l)},I=o=>{const l=o.validate();return typeof l.then=="function"?l.then(d=>({valid:d,comp:o}),d=>({valid:!1,comp:o,err:d})):Promise.resolve({valid:l,comp:o})};return(i.greedy===!0?Promise.all(s.map(I)).then(o=>o.filter(l=>l.valid!==!0)):s.reduce((o,l)=>o.then(()=>I(l).then(d=>{if(d.valid===!1)return Promise.reject(d)})),Promise.resolve()).catch(o=>[o])).then(o=>{if(o===void 0||o.length===0)return C===r&&_(!0),!0;if(C===r){const{comp:l,err:d}=o[0];if(d!==void 0&&console.error(d),_(!1,l),u===!0){const V=o.find(({comp:B})=>typeof B.focus=="function"&&j(B.$)===!1);V!==void 0&&V.comp.focus()}}return!1})}function S(){r++,s.forEach(e=>{typeof e.resetValidation=="function"&&e.resetValidation()})}function y(e){e!==void 0&&E(e);const u=r+1;g().then(C=>{u===r&&C===!0&&(i.onSubmit!==void 0?c("submit",e):e?.target!==void 0&&typeof e.target.submit=="function"&&e.target.submit())})}function x(e){e!==void 0&&E(e),c("reset"),K(()=>{S(),i.autofocus===!0&&i.noResetFocus!==!0&&a()})}function a(){M(()=>{if(n.value===null)return;(n.value.querySelector("[autofocus][tabindex], [data-autofocus][tabindex]")||n.value.querySelector("[autofocus] [tabindex], [data-autofocus] [tabindex]")||n.value.querySelector("[autofocus], [data-autofocus]")||Array.prototype.find.call(n.value.querySelectorAll("[tabindex]"),u=>u.tabIndex!==-1))?.focus({preventScroll:!0})})}G(H,{bindComponent(e){s.push(e)},unbindComponent(e){const u=s.indexOf(e);u!==-1&&s.splice(u,1)}});let t=!1;return L(()=>{t=!0}),N(()=>{t===!0&&i.autofocus===!0&&a()}),R(()=>{i.autofocus===!0&&a()}),Object.assign(p.proxy,{validate:g,resetValidation:S,submit:y,reset:x,focus:a,getValidationComponents:()=>s}),()=>A("form",{class:"q-form",ref:n,onSubmit:y,onReset:x},T(v.default))}}),se={key:0,class:"text-negative text-center q-mb-sm"},ne={class:"row justify-center"},le={__name:"LoginCard",setup(i){const v=m(""),c=m([]),p=m(!1),n=m(""),r=m(""),s=m(""),g=m(!1),S=W(),y=U();R(async()=>{p.value=!0;try{const a=await Q.get("/api/company/company-dbs");c.value=(a.data.rows||[]).map(t=>({label:t.Company,value:t.CompanyDB})),c.value.length===1&&(v.value=c.value[0].value)}catch(a){console.error("❌ Failed loading company DB list:",a),y.notify({type:"negative",message:"Unable to load company list"})}finally{p.value=!1}});async function x(){s.value="",g.value=!0;try{const a=await Q.post("/api/auth/login",{CompanyDB:v.value,UserName:n.value,Password:r.value});if(!a.data.success){s.value=a.data.message||"Login failed";return}const{cookies:t,sessionId:e}=a.data;if(!t?.B1SESSION||!t?.ROUTEID)throw new Error("Invalid SAP login response (missing cookies)");const u=`${t.B1SESSION}; ${t.ROUTEID}`;localStorage.setItem("sapCookies",u),localStorage.setItem("sapSession",e),localStorage.setItem("username",n.value),ae(!0),y.notify({type:"positive",message:"Login Successful"}),S.push("/parser")}catch(a){console.error("❌ LOGIN ERROR:",a),s.value=a.response?.data?.message||a.message||"Unable to login"}finally{g.value=!1}}return(a,t)=>(h(),O(te,{class:"q-pa-lg",style:{"min-width":"350px"}},{default:b(()=>[f(w,null,{default:b(()=>[...t[3]||(t[3]=[P("div",{class:"text-h6 text-center"},"Login",-1)])]),_:1}),f(X),f(w,null,{default:b(()=>[f(oe,{onSubmit:Y(x,["prevent"]),class:"q-gutter-md"},{default:b(()=>[f(k,{filled:"",modelValue:v.value,"onUpdate:modelValue":t[0]||(t[0]=e=>v.value=e),options:c.value,label:"Company Database",dense:"","emit-value":"","map-options":"",loading:p.value,disable:p.value,autofocus:""},null,8,["modelValue","options","loading","disable"]),f(D,{filled:"",modelValue:n.value,"onUpdate:modelValue":t[1]||(t[1]=e=>n.value=e),label:"Username",dense:""},null,8,["modelValue"]),f(D,{filled:"",modelValue:r.value,"onUpdate:modelValue":t[2]||(t[2]=e=>r.value=e),label:"Password",type:"password",dense:""},null,8,["modelValue"]),s.value?(h(),Z("div",se,J(s.value),1)):z("",!0),P("div",ne,[f(ee,{label:"Login",type:"submit",color:"primary",loading:g.value},null,8,["loading"])])]),_:1})]),_:1})]),_:1}))}},de={__name:"LoginPage",setup(i){return(v,c)=>(h(),O(q,{class:"flex flex-center"},{default:b(()=>[f(le)]),_:1}))}};export{de as default};
